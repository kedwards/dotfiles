#!/usr/bin/bash
# DO NOT EDIT THIS FILE - Generated by chezmoi tempplate

store_credentials() {
  if [ -z "$1" ]; then
    echo "Usage: store_credentials <environment>"
    echo "Stores AWS credentials from the specified profile in environment variables."
    return 1
  fi

  # Check if aws-profile_switcher function is available
  if ! command -v aws-profile_switcher >/dev/null 2>&1; then
    echo "[ERROR] aws-profile_switcher function not found. Please source AWS configuration."
    return 1
  fi

  local env=$1
  echo "[INFO] Switching to AWS profile: $env"
  aws-profile_switcher "$env"

  # Store credentials in shorter variable names
  export AK="$AWS_ACCESS_KEY_ID" SK="$AWS_SECRET_ACCESS_KEY" ST="$AWS_SESSION_TOKEN"

  if [[ -n "$AK" ]]; then
    echo "[INFO] Credentials stored successfully for profile: $env"
  else
    echo "[WARNING] No credentials found for profile: $env"
  fi

  aws-profile_switcher -u
}

# Deploys v2 infrastructure using Ansible.
# Arguments:
#   $1 - The Ansible target.
#   $2 - The Ansible environment.
#   $3 - The configuration version (optional, default is main).
#   $4 - The AWS region (optional, default is us-east-1).
#   $5 - The Ansible tags (optional).
#   $6 - The DR deploy flag (optional, default is '').
reach-v2() {
  if [ "$#" -lt 2 ]; then
    cat <<EOF
Usage: reach-v2 <target> <env> [<config>|main] [<region>|us-east-1] [<tags>]
Deploy v2 infrastructure
Parameters:
  target:  ansible target
  env:     ansible environment
  config:  configuration version
  region:  aws region
  tags:    ansible tags
  dr_deploy: DR deploy flag
EOF
    return 1
  else
    target=$1
    profile=$2
    config=${3:-main}
    region=${4:-us-east-1}
    tags=$5
    dr_deploy=$6

    store_credentials ps
    aws-profile_switcher "$profile"

    (
      unset AWS_PROFILE
      echo ANSIBLE_PYTHON_INTERPRETER="$(mise which python)" \
        make -C infra/ansible "${target}" \
        ENV="${profile}" REGION="${region}" TOPV2="$(pwd)" CONFIG="${config}" SERVICE="setup" \
        EXTRA_VARS="ps_aws_access_key_id=$AK ps_aws_secret_access_key=$SK ps_aws_session_token=$ST dr_deploy=$dr_deploy" \
        RUNTAG="${tags}"
    )
    export EXTRA_VARS=""
    export ANSIBLE_PYTHON_INTERPRETER=""
    aws-profile_switcher -u
  fi
  return 0
}
