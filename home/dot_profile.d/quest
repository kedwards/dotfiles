#!/usr/bin/env bash

# Installs a game on Oculus Quest via adb.
# Arguments:
#   -d, --dir      The path to the game directory
#   -p, --package  The package (folder) name
#   -a, --apk      The APK file name
#   -h, --help     Show this help message
quest_adb_install() {
  local game_path=""
  local packagename=""
  local apk_file=""

  # Parse arguments using getopt
  local TEMP
  TEMP=$(getopt -o d:p:a:h --long dir:,package:,apk:,help -n 'quest_adb_install' -- "$@")
  
  if [ $? != 0 ]; then
    echo "Error: Failed to parse arguments" >&2
    return 1
  fi

  eval set -- "$TEMP"

  while true; do
    case "$1" in
      -d|--dir)
        game_path="$2"
        shift 2
        ;;
      -p|--package)
        packagename="$2"
        shift 2
        ;;
      -a|--apk)
        apk_file="$2"
        shift 2
        ;;
      -h|--help)
        echo "Usage: quest_adb_install -d <dir> -p <package> -a <apk>"
        echo ""
        echo "Options:"
        echo "  -d, --dir      The path to the game directory"
        echo "  -p, --package  The package (folder) name"
        echo "  -a, --apk      The APK file name"
        echo "  -h, --help     Show this help message"
        echo ""
        echo "Requirements:"
        echo "  This script requires adb (Android Debug Bridge)."
        echo ""
        echo "To install adb:"
        echo "  - Debian/Ubuntu: sudo apt-get install adb"
        echo "  - Fedora/RHEL:   sudo dnf install android-tools"
        echo "  - Arch Linux:    sudo pacman -S android-tools"
        echo "  - macOS:         brew install android-platform-tools"
        return 0
        ;;
      --)
        shift
        break
        ;;
      *)
        echo "Internal error!" >&2
        return 1
        ;;
    esac
  done

  # Validate required arguments
  if [ -z "$game_path" ] || [ -z "$packagename" ] || [ -z "$apk_file" ]; then
    echo "Error: All arguments (-d, -p, -a) are required." >&2
    echo "Use -h or --help for usage information." >&2
    return 1
  fi

  # Check if adb is installed
  if ! command -v adb >/dev/null 2>&1; then
    echo "Error: adb is not installed or not in PATH." >&2
    return 1
  fi

  # Validate paths exist
  if [ ! -d "$game_path" ]; then
    echo "Error: Game directory does not exist: $game_path" >&2
    return 1
  fi

  if [ ! -f "$game_path/$apk_file" ]; then
    echo "Error: APK file does not exist: $game_path/$apk_file" >&2
    return 1
  fi

  # Check if device is connected
  if ! adb devices | grep -q "device$"; then
    echo "Error: No device connected. Please connect your Quest and enable USB debugging." >&2
    return 1
  fi

  # Use absolute paths instead of cd
  local full_apk_path="$game_path/$apk_file"
  local full_package_path="$game_path/$packagename"

  # Install APK with error checking
  echo "Installing APK..."
  if ! adb install -g -r "$full_apk_path"; then
    echo "Error: Failed to install APK" >&2
    return 1
  fi

  # Create OBB directory and push files if package directory exists
  if [ -d "$full_package_path" ]; then
    echo "Creating OBB directory..."
    if ! adb shell mkdir -p "/sdcard/Android/obb/$packagename" 2>/dev/null; then
      echo "Warning: Failed to create OBB directory (may already exist)" >&2
    fi
    
    echo "Pushing OBB files..."
    if ! adb push "$full_package_path" /sdcard/Android/obb/; then
      echo "Error: Failed to push OBB files" >&2
      return 1
    fi
  else
    echo "Note: No OBB directory found at $full_package_path, skipping OBB installation"
  fi

  echo "Installation complete!"
  return 0
}
