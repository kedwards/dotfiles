#!/usr/bin/env bash
#
# blur-lock - Screenshot, blur, and lock screen
#

set -euo pipefail

# Configuration
PICTURE=/tmp/i3lock.png
BLUR="5x4"

# Cleanup function
cleanup() {
    rm -f "$PICTURE"
}
trap cleanup EXIT

# Check dependencies
for cmd in scrot magick i3lock; do
    if ! command -v "$cmd" &>/dev/null; then
        notify-send "Lock Error" "$cmd is not installed" 2>/dev/null || true
        exit 1
    fi
done

# Take screenshot
if ! scrot -z "$PICTURE" 2>/dev/null; then
    notify-send "Lock Error" "Failed to take screenshot" 2>/dev/null || true
    exit 1
fi

# Blur image
if ! magick "$PICTURE" -blur "$BLUR" "$PICTURE" 2>/dev/null; then
    notify-send "Lock Error" "Failed to blur image" 2>/dev/null || true
    exit 1
fi

# Lock screen
i3lock -i "$PICTURE"
