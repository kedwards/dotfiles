#!/usr/bin/env bash
#
# i3 Keybindings Display - rofi version
# Reads keybindings from a config file and displays them in rofi
#

set -euo pipefail

# Configuration
CONFIG_FILE="${CONFIG_FILE:-${XDG_CONFIG_HOME:-$HOME/.config}/i3/scripts/keybindings.conf}"
ROFI_THEME="${ROFI_THEME:-${HOME}/.config/i3/rofi/dark_theme.rasi}"
# Position options: center, north, south, east, west, northeast, northwest, southeast, southwest
ROFI_POSITION="${ROFI_POSITION:-northeast}"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m'

# Error message function
error() {
    echo -e "${RED}Error:${NC} $*" >&2
}

# Check if rofi is available
if ! command -v rofi &> /dev/null; then
    error "rofi is not installed"
    echo ""
    echo "Install with:"
    echo "  Debian/Ubuntu: sudo apt install rofi"
    echo "  Arch Linux:    sudo pacman -S rofi"
    exit 1
fi

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    error "Config file not found: $CONFIG_FILE"
    exit 1
fi

# Parse config file and format for rofi
parse_config() {
    local config_file="$1"
    
    while IFS='|' read -r key description; do
        # Skip empty lines and comments
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
        
        # Trim whitespace
        key=$(echo "$key" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        description=$(echo "$description" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        
        # Skip if key is empty
        [[ -z "$key" ]] && continue
        
        # Format: KEY | DESCRIPTION
        # Use double tabs for short keys (â‰¤ 6 chars) to improve alignment
        local tab_separator="\t"
        if [[ ${#key} -le 6 ]]; then
            tab_separator="\t\t"
        fi
        
        printf "%s${tab_separator}%s\n" "$key" "$description"
    done < "$config_file"
}

# Display with rofi
display_with_rofi() {
    # Create header if enabled
    local header=""
    local rofi_args=(
        -dmenu
        -i
        -p ""
        -mesg "$header"
        -no-custom
        -no-click-to-exit
        -format "s"
        -location 0
        -markup-rows
        -theme-str 'inputbar {enabled: false;}'
        -theme-str 'listview {columns: 1;}'
    )
    
    # Set position based on ROFI_POSITION
    case "$ROFI_POSITION" in
        center)      rofi_args+=(-theme-str 'window {location: center; anchor: center;}') ;;
        north)       rofi_args+=(-theme-str 'window {location: north; anchor: north; y-offset: 50px;}') ;;
        south)       rofi_args+=(-theme-str 'window {location: south; anchor: south; y-offset: -50px;}') ;;
        east)        rofi_args+=(-theme-str 'window {location: east; anchor: east; x-offset: -50px;}') ;;
        west)        rofi_args+=(-theme-str 'window {location: west; anchor: west; x-offset: 50px;}') ;;
        northeast)   rofi_args+=(-theme-str 'window {location: northeast; anchor: northeast; x-offset: -50px; y-offset: 50px;}') ;;
        northwest)   rofi_args+=(-theme-str 'window {location: northwest; anchor: northwest; x-offset: 50px; y-offset: 50px;}') ;;
        southeast)   rofi_args+=(-theme-str 'window {location: southeast; anchor: southeast; x-offset: -50px; y-offset: -50px;}') ;;
        southwest)   rofi_args+=(-theme-str 'window {location: southwest; anchor: southwest; x-offset: 50px; y-offset: -50px;}') ;;
    esac
    
    # Add theme if specified
    if [[ -n "$ROFI_THEME" ]]; then
        rofi_args+=(-theme "$ROFI_THEME")
    fi
    
    # Set width to fit content (in characters)
    rofi_args+=(-width 30)
    
    # rofi returns 1 when user cancels, which is normal
    rofi "${rofi_args[@]}" || true
}

# Main execution
main() {
    parse_config "$CONFIG_FILE" | display_with_rofi
}

main "$@"
