#!/usr/bin/env bash
# DO NOT EDIT THIS FILE - Generated by chezmoi template
#
# Usage:
#   myip        # IPv4 (default)
#   myip 4      # IPv4
#   myip 6      # IPv6

set -euo pipefail

SERVICES=(
  "https://icanhazip.com"
  "https://ifconfig.me"
  "https://ident.me"
  "https://ipecho.net/plain"
)

IP_VERSION="${1:-4}"

case "$IP_VERSION" in
  4) CURL_IP_FLAG="-4" ;;
  6) CURL_IP_FLAG="-6" ;;
  *)
    echo "Usage: myip [4|6]" >&2
    exit 1
    ;;
esac

# Shuffle services for resilience
mapfile -t SHUFFLED_SERVICES < <(printf "%s\n" "${SERVICES[@]}" | shuf)

for service in "${SHUFFLED_SERVICES[@]}"; do
  ip="$(
    curl \
      --silent \
      --fail \
      --max-time 3 \
      "$CURL_IP_FLAG" \
      "$service" \
      2>/dev/null \
      | tr -d '[:space:]'
  )"

  case "$IP_VERSION" in
    4)
      if [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
        echo "$ip"
        exit 0
      fi
      ;;
    6)
      if [[ "$ip" =~ : ]]; then
        echo "$ip"
        exit 0
      fi
      ;;
  esac
done

echo "ERROR: Unable to determine public IPv$IP_VERSION address" >&2
exit 2
