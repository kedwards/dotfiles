#!/usr/bin/env bash
# DO NOT EDIT THIS FILE - Generated by chezmoi template
#
# Installs a game on Oculus Quest via adb.
#
# Usage:
#   quest-adb-install -d <dir> -p <package> -a <apk>
#
# Options:
#   -d, --dir      Path to the game directory
#   -p, --package  Package (folder) name (OBB directory)
#   -a, --apk      APK file name
#   -h, --help     Show help

set -euo pipefail

SCRIPT_NAME="${0##*/}"

usage() {
  cat <<EOF
Usage:
  $SCRIPT_NAME -d <dir> -p <package> -a <apk>

Options:
  -d, --dir      Path to the game directory
  -p, --package  Package (folder) name
  -a, --apk      APK file name
  -h, --help     Show this help message

Requirements:
  - adb (Android Debug Bridge)
  - Oculus Quest connected with USB debugging enabled

Install adb:
  Debian/Ubuntu: sudo apt install adb
  Fedora/RHEL:   sudo dnf install android-tools
  Arch Linux:    sudo pacman -S android-tools
  macOS:         brew install android-platform-tools
EOF
}

# -------------------------
# Argument parsing
# -------------------------
GAME_DIR=""
PACKAGE_NAME=""
APK_FILE=""

TEMP=$(getopt -o d:p:a:h --long dir:,package:,apk:,help -n "$SCRIPT_NAME" -- "$@") || {
  echo "ERROR: Failed to parse arguments" >&2
  exit 1
}

eval set -- "$TEMP"

while true; do
  case "$1" in
    -d|--dir)
      GAME_DIR="$2"
      shift 2
      ;;
    -p|--package)
      PACKAGE_NAME="$2"
      shift 2
      ;;
    -a|--apk)
      APK_FILE="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "ERROR: Internal argument parsing error" >&2
      exit 1
      ;;
  esac
done

# -------------------------
# Validation
# -------------------------
if [[ -z "$GAME_DIR" || -z "$PACKAGE_NAME" || -z "$APK_FILE" ]]; then
  echo "ERROR: -d, -p, and -a are required" >&2
  echo "Run '$SCRIPT_NAME --help' for usage." >&2
  exit 1
fi

if ! command -v adb >/dev/null 2>&1; then
  echo "ERROR: adb not found in PATH" >&2
  exit 1
fi

if [[ ! -d "$GAME_DIR" ]]; then
  echo "ERROR: Game directory does not exist: $GAME_DIR" >&2
  exit 1
fi

APK_PATH="$GAME_DIR/$APK_FILE"
OBB_PATH="$GAME_DIR/$PACKAGE_NAME"

if [[ ! -f "$APK_PATH" ]]; then
  echo "ERROR: APK file not found: $APK_PATH" >&2
  exit 1
fi

# -------------------------
# Device check
# -------------------------
if ! adb devices | awk 'NR>1 && $2=="device"' | grep -q .; then
  echo "ERROR: No adb device detected" >&2
  echo "Make sure your Quest is connected and USB debugging is enabled." >&2
  exit 1
fi

# -------------------------
# Install APK
# -------------------------
echo "▶ Installing APK: $APK_FILE"
adb install -g -r "$APK_PATH"

# -------------------------
# Install OBB (optional)
# -------------------------
if [[ -d "$OBB_PATH" ]]; then
  echo "▶ Installing OBB files: $PACKAGE_NAME"

  adb shell mkdir -p "/sdcard/Android/obb/$PACKAGE_NAME" >/dev/null 2>&1 || {
    echo "WARNING: Failed to create OBB directory (may already exist)" >&2
  }

  adb push "$OBB_PATH" /sdcard/Android/obb/ >/dev/null
else
  echo "ℹ No OBB directory found at $OBB_PATH — skipping"
fi

echo "✅ Installation complete"
