#!/usr/bin/env bash

THEME="$HOME/.config/i3/rofi/powerprofiles.rasi"

# Dependency checks
command -v powerprofilesctl >/dev/null 2>&1 || { echo "powerprofilesctl not found"; exit 1; }
command -v rofi >/dev/null 2>&1 || { echo "rofi not found"; exit 1; }
if ! command -v notify-send >/dev/null 2>&1; then
    notify_send_missing=true
fi

current_profile="$(powerprofilesctl get 2>/dev/null)"

# Menu entries
perf="‚ö° Performance"
balanced="‚öñ Balanced"
powersave="üîã Power Saver"

# Highlight current profile with color
if [[ "$current_profile" == "performance" ]]; then
    perf="<span foreground='#00ff00'>$perf ‚óè</span>"
elif [[ "$current_profile" == "balanced" ]]; then
    balanced="<span foreground='#00ff00'>$balanced ‚óè</span>"
elif [[ "$current_profile" == "power-saver" ]]; then
    powersave="<span foreground='#00ff00'>$powersave ‚óè</span>"
fi

options=""

if powerprofilesctl list | grep -q "performance"; then
    [[ -n "$options" ]] && options="$options\n"
    options="$options$perf"
fi
if powerprofilesctl list | grep -q "balanced"; then
    [[ -n "$options" ]] && options="$options\n"
    options="$options$balanced"
fi
if powerprofilesctl list | grep -q "power-saver"; then
    [[ -n "$options" ]] && options="$options\n"
    options="$options$powersave"
fi

chosen="$(echo -e "$options" | \
    rofi -dmenu \
        -p "Change Profile" \
        -theme "$THEME" \
        -mesg "<b>Current:</b> $current_profile" \
        -markup-rows \
        -i)"

case $chosen in
    "$perf")
        powerprofilesctl set performance
        ;;
    "$balanced")
        powerprofilesctl set balanced
        ;;
    "$powersave")
        powerprofilesctl set power-saver
        ;;
    "")
        exit 0
        ;;
esac

if [[ -n "$chosen" && -z "${notify_send_missing}" ]]; then
    notify-send -i dialog-information "Power Profile Changed" "New profile: ${chosen}"
fi
