#!/usr/bin/env bash

THEME="$HOME/.config/i3/rofi/powermenu.rasi"
LOCK_SCRIPTS=("$HOME/.config/i3/scripts/blur-lock" "i3lock")

# Find available lock script
find_lock_script() {
  for script in "${LOCK_SCRIPTS[@]}"; do
    # Handle command names vs full paths
    if [[ "$script" =~ ^[a-zA-Z0-9_-]+$ ]]; then
      # It's a command name, check if available
      if command -v "$script" >/dev/null 2>&1; then
        echo "$script"
        return 0
      fi
    else
      # It's a path, check if file exists and is executable
      if [[ -x "$script" ]]; then
        echo "$script"
        return 0
      fi
    fi
  done
  return 1
}

# Menu entries
cancel="âœ– Cancel"
lock="ğŸ”’ Lock"
logout="â» Logout"
reboot="ğŸ”„ Reboot"
shutdown="â» Shutdown"
suspend="ğŸŒ™ Suspend"
hibernate="â„ Hibernate"

# Add lock only if script is found
if lockcmd="$(find_lock_script)"; then
  options="$cancel\n$lock\n$logout\n$reboot\n$shutdown\n$suspend\n$hibernate"
else
  options="$cancel\n$logout\n$reboot\n$shutdown\n$suspend\n$hibernate"
fi

chosen="$(echo -e "$options" | \
  rofi -dmenu \
  -p "Power Menu" \
  -theme "$THEME" \
  -i)"

case $chosen in
  "$lock")
    $lockcmd
    ;;
  "$cancel" | "")
    exit 0
    ;;
  "$logout")
    i3-msg exit
    ;;
  "$reboot")
    systemctl reboot
    ;;
  "$shutdown")
    systemctl poweroff
    ;;
  "$suspend")
    systemctl suspend
    ;;
  "$hibernate")
    systemctl hibernate
    ;;
esac
